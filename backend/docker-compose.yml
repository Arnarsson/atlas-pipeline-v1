# ============================================================================
# Atlas Data Pipeline Platform - Docker Compose Configuration
# ============================================================================
# Version: 1.0
# Description: Development environment for Atlas data pipeline platform
# Usage: docker-compose up -d
# ============================================================================

version: '3.8'

services:

  # ==========================================================================
  # DATABASE SERVICES
  # ==========================================================================

  # PostgreSQL - Main application database
  db:
    image: postgres:15
    container_name: atlas-db
    restart: always
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      retries: 5
      start_period: 30s
      timeout: 10s
    volumes:
      - postgres-data:/var/lib/postgresql/data/pgdata
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    env_file:
      - .env
    environment:
      - PGDATA=/var/lib/postgresql/data/pgdata
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_DB=${POSTGRES_DB}
      # Performance tuning for development
      - POSTGRES_SHARED_BUFFERS=256MB
      - POSTGRES_EFFECTIVE_CACHE_SIZE=1GB
      - POSTGRES_MAINTENANCE_WORK_MEM=64MB
      - POSTGRES_WORK_MEM=16MB
      - POSTGRES_MAX_CONNECTIONS=100
    command: >
      postgres
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
      -c maintenance_work_mem=64MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=16MB
      -c min_wal_size=1GB
      -c max_wal_size=4GB
      -c max_worker_processes=4
      -c max_parallel_workers_per_gather=2
      -c max_parallel_workers=4
      -c logging_collector=on
      -c log_directory=/var/lib/postgresql/data/log
      -c log_filename=postgresql-%Y-%m-%d_%H%M%S.log
      -c log_min_duration_statement=1000
    networks:
      - atlas-network

  # PostgreSQL - Marquez (OpenLineage) database
  marquez-db:
    image: postgres:15
    container_name: atlas-marquez-db
    restart: always
    ports:
      - "5433:5432"
    volumes:
      - marquez-db-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=${MARQUEZ_DB_USER:-marquez}
      - POSTGRES_PASSWORD=${MARQUEZ_DB_PASSWORD:-changethis}
      - POSTGRES_DB=${MARQUEZ_DB_NAME:-marquez}
    networks:
      - atlas-network

  # Adminer - Database web UI
  adminer:
    image: adminer:latest
    container_name: atlas-adminer
    restart: always
    ports:
      - "8081:8080"
    depends_on:
      - db
    environment:
      - ADMINER_DESIGN=pepa-linha-dark
      - ADMINER_DEFAULT_SERVER=db
    networks:
      - atlas-network

  # ==========================================================================
  # CACHE & MESSAGE BROKER
  # ==========================================================================

  # Redis - Cache and message broker
  redis:
    image: redis:7-alpine
    container_name: atlas-redis
    restart: always
    ports:
      - "6379:6379"
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --appendonly yes
      --appendfsync everysec
      --save 900 1
      --save 300 10
      --save 60 10000
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - atlas-network

  # ==========================================================================
  # OBJECT STORAGE
  # ==========================================================================

  # MinIO - S3-compatible object storage
  minio:
    image: minio/minio:latest
    container_name: atlas-minio
    restart: always
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio-data:/data
    environment:
      - MINIO_ROOT_USER=${S3_ACCESS_KEY}
      - MINIO_ROOT_PASSWORD=${S3_SECRET_KEY}
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - atlas-network

  # MinIO - Create buckets on startup
  minio-init:
    image: minio/mc:latest
    container_name: atlas-minio-init
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      sleep 5;
      /usr/bin/mc alias set myminio http://minio:9000 ${S3_ACCESS_KEY} ${S3_SECRET_KEY};
      /usr/bin/mc mb myminio/${S3_BUCKET_BRONZE} --ignore-existing;
      /usr/bin/mc mb myminio/${S3_BUCKET_SILVER} --ignore-existing;
      /usr/bin/mc mb myminio/${S3_BUCKET_GOLD} --ignore-existing;
      /usr/bin/mc mb myminio/${S3_BUCKET_AI_READY} --ignore-existing;
      exit 0;
      "
    networks:
      - atlas-network

  # ==========================================================================
  # LINEAGE & METADATA
  # ==========================================================================

  # Marquez - OpenLineage backend
  marquez:
    image: marquezproject/marquez:latest
    container_name: atlas-marquez
    restart: always
    ports:
      - "5000:5000"
      - "5001:5001"
    depends_on:
      - marquez-db
    environment:
      - MARQUEZ_PORT=5000
      - MARQUEZ_ADMIN_PORT=5001
      - MARQUEZ_DB_HOST=marquez-db
      - MARQUEZ_DB_PORT=5432
      - MARQUEZ_DB_NAME=${MARQUEZ_DB_NAME:-marquez}
      - MARQUEZ_DB_USER=${MARQUEZ_DB_USER:-marquez}
      - MARQUEZ_DB_PASSWORD=${MARQUEZ_DB_PASSWORD:-changethis}
    networks:
      - atlas-network

  # ==========================================================================
  # PII DETECTION (Presidio)
  # ==========================================================================

  # Presidio Analyzer
  presidio-analyzer:
    image: mcr.microsoft.com/presidio-analyzer:latest
    container_name: atlas-presidio-analyzer
    restart: always
    ports:
      - "5002:3000"
    environment:
      - GRPC_PORT=3000
    networks:
      - atlas-network

  # Presidio Anonymizer
  presidio-anonymizer:
    image: mcr.microsoft.com/presidio-anonymizer:latest
    container_name: atlas-presidio-anonymizer
    restart: always
    ports:
      - "5003:3000"
    environment:
      - GRPC_PORT=3000
    networks:
      - atlas-network

  # ==========================================================================
  # ORCHESTRATION
  # ==========================================================================

  # Prefect Server
  prefect-server:
    image: prefecthq/prefect:2-python3.11
    container_name: atlas-prefect-server
    restart: always
    ports:
      - "4200:4200"
    volumes:
      - prefect-data:/root/.prefect
    environment:
      - PREFECT_UI_API_URL=http://localhost:4200/api
      - PREFECT_API_DATABASE_CONNECTION_URL=postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/prefect
      - PREFECT_SERVER_API_HOST=0.0.0.0
      - PREFECT_API_URL=http://localhost:4200/api
    command: prefect server start --host 0.0.0.0
    depends_on:
      - db
    networks:
      - atlas-network

  # ==========================================================================
  # APPLICATION SERVICES
  # ==========================================================================

  # Backend - Pre-start initialization
  prestart:
    image: '${DOCKER_IMAGE_BACKEND:-atlas-backend}:${TAG:-latest}'
    container_name: atlas-prestart
    build:
      context: .
      dockerfile: Dockerfile.simple
    depends_on:
      db:
        condition: service_healthy
        restart: true
    command: bash scripts/prestart.sh
    env_file:
      - .env
    environment:
      - POSTGRES_SERVER=db
      - POSTGRES_PORT=5432
      - REDIS_HOST=redis
    networks:
      - atlas-network

  # Backend - FastAPI application
  backend:
    image: '${DOCKER_IMAGE_BACKEND:-atlas-backend}:${TAG:-latest}'
    container_name: atlas-backend
    restart: always
    ports:
      - "8000:8000"
    depends_on:
      db:
        condition: service_healthy
        restart: true
      redis:
        condition: service_healthy
      prestart:
        condition: service_completed_successfully
    env_file:
      - .env
    environment:
      - POSTGRES_SERVER=db
      - POSTGRES_PORT=5432
      - REDIS_HOST=redis
      - S3_ENDPOINT=http://minio:9000
      - PRESIDIO_ANALYZER_URL=http://presidio-analyzer:3000
      - PRESIDIO_ANONYMIZER_URL=http://presidio-anonymizer:3000
      - MARQUEZ_URL=http://marquez:5000
      - PREFECT_API_URL=http://prefect-server:4200/api
    volumes:
      - ./app:/app/app
      - ./scripts:/app/scripts
      - ./tests:/app/tests
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    build:
      context: .
      dockerfile: Dockerfile.simple
    networks:
      - atlas-network

  # Celery Worker - Task processing
  celery-worker:
    image: '${DOCKER_IMAGE_BACKEND:-atlas-backend}:${TAG:-latest}'
    container_name: atlas-celery-worker
    restart: always
    command: celery -A app.workers.celery_app worker --loglevel=info --concurrency=4
    depends_on:
      - redis
      - db
    env_file:
      - .env
    environment:
      - POSTGRES_SERVER=db
      - POSTGRES_PORT=5432
      - REDIS_HOST=redis
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD}@redis:6379/1
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD}@redis:6379/2
    volumes:
      - ./app:/app/app
    networks:
      - atlas-network

  # Celery Beat - Scheduled tasks
  celery-beat:
    image: '${DOCKER_IMAGE_BACKEND:-atlas-backend}:${TAG:-latest}'
    container_name: atlas-celery-beat
    restart: always
    command: celery -A app.workers.celery_app beat --loglevel=info
    depends_on:
      - redis
      - db
    env_file:
      - .env
    environment:
      - POSTGRES_SERVER=db
      - POSTGRES_PORT=5432
      - REDIS_HOST=redis
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD}@redis:6379/1
    volumes:
      - ./app:/app/app
    networks:
      - atlas-network

  # Flower - Celery monitoring
  flower:
    image: mher/flower:latest
    container_name: atlas-flower
    restart: always
    ports:
      - "5555:5555"
    command: celery --broker=redis://:${REDIS_PASSWORD}@redis:6379/1 flower --port=5555
    depends_on:
      - redis
      - celery-worker
    environment:
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD}@redis:6379/1
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD}@redis:6379/2
    networks:
      - atlas-network

# ============================================================================
# VOLUMES
# ============================================================================
volumes:
  postgres-data:
    driver: local
  marquez-db-data:
    driver: local
  redis-data:
    driver: local
  minio-data:
    driver: local
  prefect-data:
    driver: local

# ============================================================================
# NETWORKS
# ============================================================================
networks:
  atlas-network:
    driver: bridge
    name: atlas-network
