name: Weekly Strategic Review
on:
  schedule:
    - cron: '0 17 * * 5'  # 5 PM Friday
  workflow_dispatch:

jobs:
  weekly-review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate Weekly Review
        uses: actions/github-script@v7
        with:
          script: |
            // Get issues from this week
            const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              since: oneWeekAgo.toISOString()
            });
            
            const completed = issues.filter(issue => issue.state === 'closed');
            const inProgress = issues.filter(issue => issue.state === 'open');
            
            // Analyze by project
            const projects = ['SEVEN', 'ALLIGN', 'HARKA', 'Atlas'];
            const projectStats = {};
            
            projects.forEach(project => {
              const projectIssues = issues.filter(issue => 
                issue.labels.some(label => label.name === project)
              );
              projectStats[project] = {
                total: projectIssues.length,
                completed: projectIssues.filter(i => i.state === 'closed').length,
                completion_rate: projectIssues.length > 0 ? 
                  Math.round((projectIssues.filter(i => i.state === 'closed').length / projectIssues.length) * 100) : 0
              };
            });
            
            const reviewContent = `# ðŸ“ˆ Seven Weekly Strategic Review
            
## ðŸ† Week's Accomplishments
- **Total Tasks Completed:** ${completed.length}
- **Tasks In Progress:** ${inProgress.length}
- **Overall Completion Rate:** ${issues.length > 0 ? Math.round((completed.length / issues.length) * 100) : 0}%

## ðŸ“Š Project Performance

${projects.map(project => `
### ${project}
- Tasks: ${projectStats[project].total}
- Completed: ${projectStats[project].completed}
- Completion Rate: ${projectStats[project].completion_rate}%
`).join('')}

## ðŸŽ¯ Strategic Insights

### High Performers
${Object.entries(projectStats)
  .sort(([,a], [,b]) => b.completion_rate - a.completion_rate)
  .slice(0, 2)
  .map(([project, stats]) => `- **${project}**: ${stats.completion_rate}% completion rate`)
  .join('\n')}

### Focus Areas for Next Week
- Accelerate progress on lower-performing projects
- Maintain momentum on high-performing areas
- Address any blocking issues early

## ðŸš€ Next Week's Strategic Focus
1. **Priority Projects**: Continue momentum on high-velocity work
2. **Process Improvements**: Identify and eliminate bottlenecks  
3. **Business Development**: Advance client and investor relationships

---
*Generated by Seven Intelligence System - ${new Date().toLocaleDateString()}*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ“ˆ Weekly Strategic Review - ${new Date().toLocaleDateString()}`,
              body: reviewContent,
              labels: ['ðŸ“ˆ weekly-review', 'ðŸ¤– automation', 'ðŸ“Š analytics', 'ðŸŽ¯ strategic']
            });

