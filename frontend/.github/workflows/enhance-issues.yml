name: Enhance Issues with Context

on:
  issues:
    types: [opened]

jobs:
  enhance-issue:
    runs-on: ubuntu-latest
    
    # Skip if the issue was created by Claude (github-actions bot or specific usernames)
    if: github.actor != 'github-actions[bot]' && github.actor != 'claude-ai' && github.actor != 'anthropic-claude'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # sqlite3, argparse, re, json are built-in modules
        
    - name: Extract issue information
      id: issue_info
      env:
        ISSUE_TITLE: ${{ github.event.issue.title }}
        ISSUE_BODY: ${{ github.event.issue.body }}
      run: |
        # Extract keywords from title and body
        KEYWORDS=$(python3 -c "
        import re
        import os
        
        title = os.environ.get('ISSUE_TITLE', '')
        body = os.environ.get('ISSUE_BODY', '')
        
        # Combine title and body
        text = f'{title} {body}'
        
        # Extract meaningful words (3+ chars, alphanumeric)
        words = re.findall(r'\b[a-zA-Z]{3,}\b', text.lower())
        
        # Remove common words
        stopwords = {'the', 'and', 'for', 'are', 'but', 'not', 'you', 'all', 'can', 'had', 'her', 'was', 'one', 'our', 'out', 'day', 'get', 'has', 'him', 'his', 'how', 'its', 'may', 'new', 'now', 'old', 'see', 'two', 'way', 'who', 'boy', 'did', 'man', 'car', 'use', 'make', 'work', 'time', 'been', 'have', 'will', 'with', 'this', 'that', 'they', 'from', 'when', 'what', 'where', 'would', 'could', 'should', 'about', 'after', 'before', 'during', 'under', 'over', 'through', 'between', 'because', 'since', 'until', 'while', 'issue', 'github', 'repository', 'repo'}
        
        # Filter out stopwords and get unique meaningful keywords
        keywords = list(set([w for w in words if w not in stopwords and len(w) >= 3]))
        
        # Limit to top 10 keywords to avoid overly long searches
        keywords = keywords[:10]
        
        print(' '.join(keywords))
        ")
        echo "keywords=$KEYWORDS" >> $GITHUB_OUTPUT
        
    - name: Search for relevant conversations
      id: search
      if: steps.issue_info.outputs.keywords != ''
      run: |
        # Check if database exists
        if [ ! -f "data/seven.db" ]; then
          echo "‚ö†Ô∏è Database not found, skipping context search"
          echo "has_results=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Run the search script with extracted keywords
        SEARCH_RESULTS=$(python3 scripts/search_conversations.py "${{ steps.issue_info.outputs.keywords }}" --limit 5 2>/dev/null || echo "")
        
        # Check if we have meaningful results (script outputs formatted results or nothing)
        if [ -n "$SEARCH_RESULTS" ] && [ "$SEARCH_RESULTS" != "üîç No results found"* ]; then
          echo "has_results=true" >> $GITHUB_OUTPUT
          # Escape newlines for GitHub output and format for markdown
          echo "results<<EOF" >> $GITHUB_OUTPUT
          echo "$SEARCH_RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "has_results=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Add context comment to issue
      if: steps.search.outputs.has_results == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        ISSUE_NUMBER: ${{ github.event.issue.number }}
        SEARCH_RESULTS: ${{ steps.search.outputs.results }}
      run: |
        # Create the comment using GitHub CLI with error handling
        cat > comment.md << 'EOF'
        ## üîç Related Context

        I found some relevant conversations from our knowledge base that might provide helpful context for this issue:

        ${{ steps.search.outputs.results }}

        ---
        *This context was automatically generated by searching our conversation database using keywords from the issue. The results show previous discussions that may contain relevant solutions, patterns, or insights.*
        EOF
        
        if gh issue comment $ISSUE_NUMBER --body-file comment.md 2>/dev/null; then
          echo "‚úÖ Successfully added context comment to issue #$ISSUE_NUMBER"
        else
          echo "‚ö†Ô∏è Failed to add comment to issue #$ISSUE_NUMBER, but continuing workflow"
        fi
        
        rm -f comment.md
      
    - name: Log enhancement status
      run: |
        echo "üìä Issue Enhancement Summary:"
        echo "   Issue: #${{ github.event.issue.number }} - '${{ github.event.issue.title }}'"
        echo "   Author: ${{ github.event.issue.user.login }}"
        echo "   Keywords extracted: ${{ steps.issue_info.outputs.keywords }}"
        
        if [ "${{ steps.search.outputs.has_results }}" == "true" ]; then
          echo "   Status: ‚úÖ Enhanced with relevant context"
        elif [ ! -f "data/seven.db" ]; then
          echo "   Status: ‚ö†Ô∏è Database not available - enhancement skipped"
        elif [ "${{ steps.issue_info.outputs.keywords }}" == "" ]; then
          echo "   Status: ‚ÑπÔ∏è No keywords found - enhancement skipped"
        else
          echo "   Status: ‚ÑπÔ∏è No relevant context found"
        fi